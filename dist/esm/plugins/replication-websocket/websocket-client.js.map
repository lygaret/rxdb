{"version":3,"file":"websocket-client.js","names":["replicateRxCollection","ReconnectingWebSocket","IsomorphicWebSocket","randomToken","filter","map","Subject","firstValueFrom","BehaviorSubject","newRxError","ensureIsWebsocket","w","is","CLOSING","console","dir","Error","createWebSocketClient","options","wsClient","url","WebSocket","connected$","message$","error$","onerror","err","log","emitError","errors","direction","next","Promise","res","onopen","headers","authMessage","collection","name","id","params","method","send","JSON","stringify","onclose","onmessage","messageObj","message","parse","data","socket","replicateWithWebsocketServer","websocketClient","messages$","requestCounter","requestFlag","getRequestId","count","database","token","replicationState","replicationIdentifier","live","pull","batchSize","stream$","pipe","msg","result","handler","lastPulledCheckpoint","requestId","request","push","docs","subscribe","subjects","error","isConnected","reSync","streamRequest","onClose","close"],"sources":["../../../../src/plugins/replication-websocket/websocket-client.ts"],"sourcesContent":["import {\n    replicateRxCollection,\n    RxReplicationState\n} from '../replication/index.ts';\nimport {\n    WebsocketClientOptions,\n    WebsocketMessageType\n} from './websocket-types.ts';\n\nimport ReconnectingWebSocket from 'reconnecting-websocket';\n\nimport IsomorphicWebSocket from 'isomorphic-ws';\nimport {\n    errorToPlainJson,\n    randomToken,\n    toArray\n} from '../../plugins/utils/index.ts';\nimport {\n    filter,\n    map,\n    Subject,\n    firstValueFrom,\n    BehaviorSubject\n} from 'rxjs';\nimport type {\n    RxError,\n    RxReplicationWriteToMasterRow\n} from '../../types/index.d.ts';\nimport { newRxError } from '../../rx-error.ts';\n\nexport type WebsocketClient = {\n    url: string;\n    socket: any;\n    connected$: BehaviorSubject<boolean>;\n    message$: Subject<any>;\n    error$: Subject<RxError>;\n};\n\n\n/**\n * Copied and adapted from the 'reconnecting-websocket' npm module.\n * Some bundlers have problems with bundling the isomorphic-ws plugin\n * so we directly check the correctness in RxDB to ensure that we can\n * throw a helpful error.\n */\nexport function ensureIsWebsocket(w: typeof IsomorphicWebSocket) {\n    const is = typeof w !== 'undefined' && !!w && w.CLOSING === 2;\n    if (!is) {\n        console.dir(w);\n        throw new Error('websocket not valid');\n    }\n}\n\n\nexport async function createWebSocketClient<RxDocType>(options: WebsocketClientOptions<RxDocType>): Promise<WebsocketClient> {\n    ensureIsWebsocket(IsomorphicWebSocket);\n    const wsClient = new ReconnectingWebSocket(\n        options.url,\n        [],\n        {\n            WebSocket: IsomorphicWebSocket\n        }\n    );\n    const connected$ = new BehaviorSubject<boolean>(false);\n    const message$ = new Subject<any>();\n    const error$ = new Subject<any>();\n    wsClient.onerror = (err) => {\n\n        console.log('--- WAS CLIENT GOT ERROR:');\n        console.log(err);\n\n        const emitError = newRxError('RC_STREAM', {\n            errors: [new Error(\"was client error\")],\n            direction: 'pull'\n        });\n        error$.next(emitError);\n    };\n    await new Promise<void>(res => {\n        wsClient.onopen = () => {\n\n            if (options.headers) {\n                const authMessage: WebsocketMessageType = {\n                    collection: options.collection.name,\n                    id: randomToken(10),\n                    params: [options.headers],\n                    method: 'auth'\n                };\n                wsClient.send(JSON.stringify(authMessage));\n            }\n\n            connected$.next(true);\n            res();\n        };\n    });\n    wsClient.onclose = () => {\n        connected$.next(false);\n    };\n\n    wsClient.onmessage = (messageObj) => {\n        const message = JSON.parse(messageObj.data);\n        message$.next(message);\n    };\n\n    return {\n        url: options.url,\n        socket: wsClient,\n        connected$,\n        message$,\n        error$\n    };\n\n}\n\nexport async function replicateWithWebsocketServer<RxDocType, CheckpointType>(\n    options: WebsocketClientOptions<RxDocType>\n): Promise<RxReplicationState<RxDocType, CheckpointType>> {\n    const websocketClient = await createWebSocketClient(options);\n    const wsClient = websocketClient.socket;\n    const messages$ = websocketClient.message$;\n\n    let requestCounter = 0;\n    const requestFlag = randomToken(10);\n    function getRequestId() {\n        const count = requestCounter++;\n        return options.collection.database.token + '|' + requestFlag + '|' + count;\n    }\n    const replicationState = replicateRxCollection<RxDocType, CheckpointType>({\n        collection: options.collection,\n        replicationIdentifier: options.replicationIdentifier,\n        live: options.live,\n        pull: {\n            batchSize: options.batchSize,\n            stream$: messages$.pipe(\n                filter(msg => msg.id === 'stream' && msg.collection === options.collection.name),\n                map(msg => msg.result)\n            ),\n            async handler(lastPulledCheckpoint: CheckpointType | undefined, batchSize: number) {\n                const requestId = getRequestId();\n                const request: WebsocketMessageType = {\n                    id: requestId,\n                    collection: options.collection.name,\n                    method: 'masterChangesSince',\n                    params: [lastPulledCheckpoint, batchSize]\n                };\n                wsClient.send(JSON.stringify(request));\n                const result = await firstValueFrom(\n                    messages$.pipe(\n                        filter(msg => msg.id === requestId),\n                        map(msg => msg.result)\n                    )\n                );\n                return result;\n            }\n        },\n        push: {\n            batchSize: options.batchSize,\n            handler(docs: RxReplicationWriteToMasterRow<RxDocType>[]) {\n                const requestId = getRequestId();\n                const request: WebsocketMessageType = {\n                    id: requestId,\n                    collection: options.collection.name,\n                    method: 'masterWrite',\n                    params: [docs]\n                };\n                wsClient.send(JSON.stringify(request));\n                return firstValueFrom(\n                    messages$.pipe(\n                        filter(msg => msg.id === requestId),\n                        map(msg => msg.result)\n                    )\n                );\n            }\n        }\n    });\n\n    websocketClient.error$.subscribe(err => replicationState.subjects.error.next(err));\n\n    websocketClient.connected$.subscribe(isConnected => {\n        if (isConnected) {\n            /**\n             * When the client goes offline and online again,\n             * we have to send a 'RESYNC' signal because the client\n             * might have missed out events while being offline.\n             */\n            replicationState.reSync();\n\n            /**\n             * Because reconnecting creates a new websocket-instance,\n             * we have to start the changestream from the remote again\n             * each time.\n             */\n            const streamRequest: WebsocketMessageType = {\n                id: 'stream',\n                collection: options.collection.name,\n                method: 'masterChangeStream$',\n                params: []\n            };\n            wsClient.send(JSON.stringify(streamRequest));\n        }\n    });\n\n    options.collection.onClose.push(() => websocketClient.socket.close());\n    return replicationState;\n}\n"],"mappings":"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","ignoreList":[]}